---
- name: Set plugin name
  ansible.builtin.set_fact:
    plugins_label: "CoreProtect"
    plugins_path: "plugins/CoreProtect"

- name: "Download {{ plugins_label }}"
  # Why are we downloading after stopping?
  # Because we are downloading directly to the plugins/ directory.
  ansible.builtin.get_url:
    url: "https://www.patreon.com/file?h=136053027&m=513054290"
    dest: "{{ plugins_dir }}/CoreProtect.jar"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: "0644"

- name: "Restart minecraft service after installing {{ plugins_label }}"
  ansible.builtin.include_role:
    name: restart_server

- name: "Copy configuration files for {{ plugins_label }}"
  ansible.posix.synchronize:
    delete: true
    recursive: true
    src: "../../big_lc/{{ plugins_path }}"
    dest: "{{ minecraft_server_dir }}/{{ plugins_path }}"
    partial: true
    mode: "push"

- name: "Copy license file for {{ plugins_label }}"
  ansible.builtin.copy:
    src: "../../big_lc/{{ plugins_path }}/.license"
    dest: "{{ minecraft_server_dir }}/{{ plugins_path }}"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_user }}"
    mode: "0644"

- name: "Reset config file ownership/permissions for {{ plugins_label }}"
  ansible.builtin.file:
    path: "{{ minecraft_server_dir }}/{{ plugins_path }}"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: "0644"
    state: "directory"
    recurse: true

- name: "Reset config dir ownership/permissions for {{ plugins_label }}"
  ansible.builtin.file:
    path: "{{ minecraft_server_dir }}/{{ plugins_path }}"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: "0744"
    state: "directory"
    recurse: false

- name: "Restart minecraft service after configuring {{ plugins_label }}"
  ansible.builtin.include_role:
    name: restart_server
