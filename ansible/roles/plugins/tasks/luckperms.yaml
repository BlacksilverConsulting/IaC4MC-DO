---
- name: Set plugin name
  ansible.builtin.set_fact:
    plugins_label: "LuckPerms"

- name: "Stop minecraft service before installing {{ plugins_label }}"
  ansible.builtin.service:
    name: minecraft
    state: stopped

- name: "Download {{ plugins_label }}"
  # Why are we downloading after stopping?
  # Because we are downloading directly to the plugins/ directory.
  ansible.builtin.get_url:
    url: "https://download.luckperms.net/1596/bukkit/loader/LuckPerms-Bukkit-5.5.11.jar"
    dest: "{{ plugins_dir }}/LuckPerms.jar"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: "0644"

- name: "Start minecraft service after installing {{ plugins_label }}"
  ansible.builtin.service:
    name: minecraft
    state: restarted

- name: "Wait for server to come up after installing {{ plugins_label }}"
  ansible.builtin.wait_for:
    port: "{{ server_port }}"
    state: started
    timeout: "{{ startup_timeout }}"
  register: plugins_restart

- name: "Check startup result after installing {{ plugins_label }}"
  ansible.builtin.fail:
    msg: "The Minecraft service did not start within {{ startup_timeout }} seconds"
  when: not plugins_restart.elapsed
