---
- name: Set plugin name
  ansible.builtin.set_fact:
    plugins_name: "EssentialsX Config"
    plugins_path: "plugins/Essentials"

- name: "Stop minecraft service before installing {{ plugins_name }}"
  ansible.builtin.service:
    name: minecraft
    state: stopped

- name: "Copy configuration files for {{ plugins_name }}"
  ansible.posix.synchronize:
    delete: true
    recursive: true
    src: "../../big_lc/{{ plugins_path }}"
    dest: "{{ minecraft_server_dir }}/{{ plugins_path }}"
    partial: true
    mode: "push"

- name: "Reset config file ownership/permissions for {{ plugins_name }}"
  ansible.builtin.file:
    path: "{{ minecraft_server_dir }}/{{ plugins_path }}"
    owner: "{{ minecraft_user }}"
    group: "{{ minecraft_group }}"
    mode: "0644"
    state: "directory"
    recurse: true

- name: "Start minecraft service after installing {{ plugins_name }}"
  ansible.builtin.service:
    name: minecraft
    state: restarted

- name: "Post-install wait for server to come up after {{ plugins_name }}"
  ansible.builtin.wait_for:
    port: "{{ server_port }}"
    state: started
    timeout: "{{ startup_timeout }}"
  register: plugins_restart

- name: "Check startup result after installing {{ plugins_name }}"
  ansible.builtin.fail:
    msg: "The Minecraft service did not start within {{ startup_timeout }} seconds"
  when: not plugins_restart.elapsed
